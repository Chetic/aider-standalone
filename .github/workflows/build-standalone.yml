name: Build standalone aider

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      aider_version:
        description: "Optional aider version (defaults to latest PyPI release)"
        required: false
        type: string
      force_rebuild:
        description: "Force rebuild even if release exists for this version"
        required: false
        type: boolean
        default: false
      use_main_branch:
        description: "Build from aider main branch instead of PyPI release"
        required: false
        type: boolean
        default: false
      variant:
        description: "Which aider variant to build"
        required: false
        type: choice
        options:
          - aider-chat
          - aider-ce
        default: aider-chat

env:
  PYTHONUNBUFFERED: '1'

jobs:
  build:
    name: Build standalone release
    runs-on: ubuntu-latest
    container:
      image: registry.access.redhat.com/ubi9/python-311:latest
      options: --user 0
    steps:
      - name: Install system dependencies
        run: |
          dnf install -y git gcc redhat-rpm-config findutils openssl-devel libffi-devel
          dnf install -y python3-devel || dnf install -y python3.11-devel
          dnf clean all

      - uses: actions/checkout@v4

      - name: Clone aider main branch
        id: clone_aider
        if: ${{ github.event.inputs.use_main_branch == 'true' }}
        run: |
          VARIANT="${{ github.event.inputs.variant || 'aider-chat' }}"
          if [ "$VARIANT" = "aider-ce" ]; then
            REPO_URL="https://github.com/ErichBSchulz/aider-ce.git"
          else
            REPO_URL="https://github.com/Aider-AI/aider.git"
          fi
          git clone --depth 1 "$REPO_URL" aider-source
          cd aider-source
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date +%Y%m%d)
          echo "commit_hash=${COMMIT_HASH}" >> "$GITHUB_OUTPUT"
          echo "build_date=${BUILD_DATE}" >> "$GITHUB_OUTPUT"
          echo "aider_source_path=$(pwd)" >> "$GITHUB_OUTPUT"
          echo "Cloned $VARIANT main branch at commit ${COMMIT_HASH}"

      - name: Resolve aider version (PyPI)
        id: aider_version
        if: ${{ github.event.inputs.use_main_branch != 'true' }}
        run: |
          REQUESTED="${{ github.event.inputs.aider_version || '' }}"
          VARIANT="${{ github.event.inputs.variant || 'aider-chat' }}"
          if [ -n "$REQUESTED" ]; then
            python scripts/fetch_aider_release.py --requested "$REQUESTED" --variant "$VARIANT" --github-output "$GITHUB_OUTPUT"
          else
            python scripts/fetch_aider_release.py --variant "$VARIANT" --github-output "$GITHUB_OUTPUT"
          fi

      - name: Set aider version (main branch)
        id: aider_version_main
        if: ${{ github.event.inputs.use_main_branch == 'true' }}
        run: |
          VERSION="main-${{ steps.clone_aider.outputs.build_date }}-${{ steps.clone_aider.outputs.commit_hash }}"
          echo "aider_version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Using aider main branch version: ${VERSION}"

      - name: Check for existing release
        id: check_existing
        if: ${{ github.event.inputs.force_rebuild != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USE_MAIN_BRANCH: ${{ github.event.inputs.use_main_branch }}
          VARIANT: ${{ github.event.inputs.variant || 'aider-chat' }}
          AIDER_VERSION: ${{ github.event.inputs.use_main_branch == 'true' && steps.aider_version_main.outputs.aider_version || steps.aider_version.outputs.aider_version }}
          BUILD_DATE: ${{ steps.clone_aider.outputs.build_date }}
          COMMIT_HASH: ${{ steps.clone_aider.outputs.commit_hash }}
        run: |
          if [ "$VARIANT" = "aider-ce" ]; then
            PREFIX="standalone-ce"
          else
            PREFIX="standalone"
          fi
          if [ "$USE_MAIN_BRANCH" = "true" ]; then
            PATTERN="${PREFIX}-main-${BUILD_DATE}-${COMMIT_HASH}-build"
          else
            PATTERN="${PREFIX}-v${AIDER_VERSION}-build"
          fi
          if gh release list --limit 100 | grep -q "$PATTERN"; then
            echo "Release already exists for $VARIANT ${AIDER_VERSION}"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if release exists
        if: ${{ steps.check_existing.outputs.skip == 'true' }}
        env:
          AIDER_VERSION: ${{ github.event.inputs.use_main_branch == 'true' && steps.aider_version_main.outputs.aider_version || steps.aider_version.outputs.aider_version }}
        run: |
          echo "::notice::Skipping build - release already exists for aider ${AIDER_VERSION}. Use force_rebuild=true to override."

      - name: Compute build metadata
        if: ${{ steps.check_existing.outputs.skip != 'true' }}
        id: versioning
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          AIDER_VERSION: ${{ github.event.inputs.use_main_branch == 'true' && steps.aider_version_main.outputs.aider_version || steps.aider_version.outputs.aider_version }}
          USE_MAIN_BRANCH: ${{ github.event.inputs.use_main_branch }}
          VARIANT: ${{ github.event.inputs.variant || 'aider-chat' }}
          BUILD_DATE: ${{ steps.clone_aider.outputs.build_date }}
          COMMIT_HASH: ${{ steps.clone_aider.outputs.commit_hash }}
        run: |
          mkdir -p build
          if [ "$USE_MAIN_BRANCH" = "true" ]; then
            python scripts/compute_version.py \
              --aider-version "$AIDER_VERSION" \
              --source-type main \
              --variant "$VARIANT" \
              --date "$BUILD_DATE" \
              --commit-hash "$COMMIT_HASH" \
              --output build/version.json \
              --github-output "$GITHUB_OUTPUT"
          else
            python scripts/compute_version.py \
              --aider-version "$AIDER_VERSION" \
              --variant "$VARIANT" \
              --output build/version.json \
              --github-output "$GITHUB_OUTPUT"
          fi

      - name: Build standalone executable
        if: ${{ steps.check_existing.outputs.skip != 'true' }}
        env:
          AIDER_VERSION: ${{ github.event.inputs.use_main_branch == 'true' && steps.aider_version_main.outputs.aider_version || steps.aider_version.outputs.aider_version }}
          BUILD_NUMBER: ${{ steps.versioning.outputs.build_number }}
          USE_MAIN_BRANCH: ${{ github.event.inputs.use_main_branch }}
          VARIANT: ${{ github.event.inputs.variant || 'aider-chat' }}
          AIDER_SOURCE_PATH: ${{ steps.clone_aider.outputs.aider_source_path }}
        run: |
          if [ "$USE_MAIN_BRANCH" = "true" ]; then
            python scripts/build_standalone.py \
              --aider-version "$AIDER_VERSION" \
              --build-number "$BUILD_NUMBER" \
              --variant "$VARIANT" \
              --output-dir build/artifacts \
              --metadata build/manifest.json \
              --aider-source-path "$AIDER_SOURCE_PATH"
          else
            python scripts/build_standalone.py \
              --aider-version "$AIDER_VERSION" \
              --build-number "$BUILD_NUMBER" \
              --variant "$VARIANT" \
              --output-dir build/artifacts \
              --metadata build/manifest.json
          fi

      - name: Smoke test executable
        if: ${{ steps.check_existing.outputs.skip != 'true' }}
        env:
          BUILD_NUMBER: ${{ steps.versioning.outputs.build_number }}
        run: |
          build/artifacts/aider-standalone-build${BUILD_NUMBER} --help >/dev/null

      - name: Upload artifacts
        if: ${{ steps.check_existing.outputs.skip != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.versioning.outputs.artifact_name }}
          path: |
            build/manifest.json
            build/artifacts/aider-standalone-build${{ steps.versioning.outputs.build_number }}
            build/artifacts/requirements.lock

      - name: Publish GitHub release (PyPI)
        if: ${{ steps.check_existing.outputs.skip != 'true' && github.event.inputs.use_main_branch != 'true' }}
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.versioning.outputs.tag_name }}
          name: Standalone ${{ github.event.inputs.variant || 'aider-chat' }} ${{ steps.versioning.outputs.tag_name }}
          body: |
            ## Standalone ${{ github.event.inputs.variant || 'aider-chat' }} release
            * Variant: ${{ github.event.inputs.variant || 'aider-chat' }}
            * Version: ${{ steps.aider_version.outputs.aider_version }}
            * Build number: ${{ steps.versioning.outputs.build_number }}
            * Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          files: |
            build/manifest.json
            build/artifacts/aider-standalone-build${{ steps.versioning.outputs.build_number }}
            build/artifacts/requirements.lock

      - name: Publish GitHub release (main branch)
        if: ${{ steps.check_existing.outputs.skip != 'true' && github.event.inputs.use_main_branch == 'true' }}
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VARIANT: ${{ github.event.inputs.variant || 'aider-chat' }}
        with:
          tag_name: ${{ steps.versioning.outputs.tag_name }}
          name: Standalone ${{ github.event.inputs.variant || 'aider-chat' }} ${{ steps.versioning.outputs.tag_name }}
          body: |
            ## Standalone ${{ github.event.inputs.variant || 'aider-chat' }} release (main branch)
            * Variant: ${{ github.event.inputs.variant || 'aider-chat' }}
            * Source: main branch
            * Commit: ${{ steps.clone_aider.outputs.commit_hash }}
            * Build date: ${{ steps.clone_aider.outputs.build_date }}
            * Build number: ${{ steps.versioning.outputs.build_number }}
            * Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          files: |
            build/manifest.json
            build/artifacts/aider-standalone-build${{ steps.versioning.outputs.build_number }}
            build/artifacts/requirements.lock
